
LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so

<VirtualHost *:80>

    RewriteEngine on
    RewriteCond %{HTTPS} off [OR]
    RewriteCond %{HTTP:X-Forwarded-Proto} !https
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

#      ServerName ${SERVER_NAME}
#      ServerAlias ${SERVER_ALIAS}

#      ServerAdmin ${SERVER_ADMIN}
#      DocumentRoot ${APACHE_DOCUMENT_ROOT}

#      # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
#      # error, crit, alert, emerg.
#      # It is also possible to configure the loglevel for particular
#      # modules, e.g.
#      #LogLevel info ssl:warn

#      ### ErrorLog ${APACHE_LOG_DIR}/error.log
#      ### CustomLog ${APACHE_LOG_DIR}/access.log combined
#      ErrorLog ${APACHE_ERROR_LOG}
#      CustomLog ${APACHE_ACCESS_LOG} combined

#      ## Below lines belong to overrides
#      # RewriteCond %{HTTPS} off
#      # RewriteRule ^/(.*)$  https://${VHOST_NAME}:${VHOST_SSL_PORT}/$1

#      # For most configuration files from conf-available/, which are
#      # enabled or disabled at a global level, it is possible to
#      # include a line for only one particular virtual host. For example the
#      # following line enables the CGI configuration for this host only
#      # after it has been globally disabled with "a2disconf".
#      # Include conf-available/serve-cgi-bin.conf
#      IncludeOptional /etc/apache2/sites-enabled/default.virtualhost
</VirtualHost>

LoadModule socache_shmcb_module /usr/lib/apache2/modules/mod_socache_shmcb.so
LoadModule ssl_module /usr/lib/apache2/modules/mod_ssl.so

<IfModule ssl_module>

    SSLRandomSeed startup builtin
    SSLRandomSeed startup file:/dev/urandom 512
    SSLRandomSeed connect builtin
    SSLRandomSeed connect file:/dev/urandom 512

    Listen 443

    SSLCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
    SSLProxyCipherSuite HIGH:MEDIUM:!MD5:!RC4:!3DES
    SSLHonorCipherOrder on

    SSLProtocol all -SSLv3
    SSLProxyProtocol all -SSLv3

    SSLPassPhraseDialog  builtin

    SSLSessionCache         shmcb:${APACHE_RUN_DIR}/ssl_scache(512000)
    SSLSessionCacheTimeout  300

    <VirtualHost *:443>

        SSLEngine on
        SSLCertificateFile "${SSL_CERT_FILE}"
        SSLCertificateKeyFile "${SSL_KEY_FILE}"

        ServerName ${SERVER_NAME}
        ServerAlias ${SERVER_ALIAS}

        ServerAdmin ${SERVER_ADMIN}
        DocumentRoot ${APACHE_DOCUMENT_ROOT}

        ErrorLog ${APACHE_ERROR_LOG}
        CustomLog ${APACHE_ACCESS_LOG} combined
        IncludeOptional /etc/apache2/sites-enabled/default.virtualhost

        <FilesMatch "\.(cgi|shtml|phtml|php)$">
            SSLOptions +StdEnvVars
        </FilesMatch>

        BrowserMatch "MSIE [2-5]" \
                 nokeepalive ssl-unclean-shutdown \
                 downgrade-1.0 force-response-1.0
    </VirtualHost>
</IfModule>
